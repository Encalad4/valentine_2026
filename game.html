<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Emoji Merge üíñ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- EMAILJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #fff0f3;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  overflow-x: hidden;
}

h1 {
  margin: 16px 0;
  color: #d6336c;
}

.grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  width: 90%;
  max-width: 420px;
}

.tile {
  background: white;
  border-radius: 18px;
  height: 72px;
  font-size: 2rem;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: grab;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  user-select: none;
  touch-action: none;
}

.tile.dragging {
  opacity: 0.5;
  cursor: grabbing;
}

/* === INSTRUCTIONS === */

.instructions {
  margin-top: 20px;
  width: 90%;
  max-width: 420px;
  background: white;
  border-radius: 18px;
  padding: 16px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.12);
  font-size: 0.9rem;
  line-height: 1.4;
}

.instructions h2 {
  margin: 8px 0;
  color: #d6336c;
  font-size: 1.1rem;
}

.instructions ul {
  padding-left: 18px;
  margin: 8px 0;
}

.hierarchy {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 8px;
}

.hierarchy span {
  background: #fff0f3;
  border-radius: 12px;
  padding: 6px 10px;
  font-size: 1.1rem;
}

/* === MODAL === */

.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s ease;
  z-index: 1000;
}

.modal-overlay.show {
  opacity: 1;
  pointer-events: auto;
}

.modal {
  background: white;
  border-radius: 22px;
  padding: 24px;
  width: 90%;
  max-width: 360px;
  text-align: center;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  animation: pop 0.3s ease;
}

.modal h2 {
  margin: 0 0 12px;
  font-size: 2rem;
}

.modal p {
  font-size: 1rem;
  margin-bottom: 20px;
}

.modal-buttons {
  display: flex;
  gap: 12px;
}

.btn {
  flex: 1;
  border: none;
  border-radius: 14px;
  padding: 10px;
  font-size: 0.95rem;
  cursor: pointer;
}

.btn.accept {
  background: #ffd6e0;
}

.btn.super-accept {
  background: #ff8fab;
  color: white;
  font-weight: bold;
}

@keyframes pop {
  from { transform: scale(0.9); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

/* === CONFETTI === */

.confetti-container {
  position: fixed;
  inset: 0;
  pointer-events: none;
  overflow: hidden;
  z-index: 2000;
}

.confetti {
  position: absolute;
  width: 10px;
  height: 10px;
  opacity: 0.9;
  animation: fall linear forwards;
}

@keyframes fall {
  to {
    transform: translateY(110vh) rotate(720deg);
    opacity: 0;
  }
}
</style>
</head>

<body>

<h1>Mezcla los emojis üíï</h1>

<div class="grid" id="grid"></div>
<div class="instructions" id="instructions"></div>

<!-- === MODAL === -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <h2>üíå</h2>
    <p id="modal-text"></p>
    <div class="modal-buttons">
      <button class="btn accept" data-answer="Acepto">Acepto</button>
      <button class="btn super-accept" data-answer="Re contra acepto">Re contra acepto</button>
    </div>
  </div>
</div>

<!-- CONFETTI -->
<div class="confetti-container" id="confetti"></div>

<script>
/* =======================
   EMAILJS INIT
======================= */
(function(){
  emailjs.init("PF2gYEKUtlr4qjaqc");
})();

/* =======================
   GAME CONFIGURATION
======================= */

const HIERARCHY = ["üíß","üå±","üåø","üå∏","ü¶ã","üíï","‚ù§Ô∏è","üíñ","üíå","üìú"];
const BASIC = "üíß";
const GRID_SIZE = 12;

const SOUNDS = [
  "sounds/yipi.mp3",
  "sounds/nice.mp3",
  "sounds/kiss.mp3",
  "sounds/eso.mp3",
  "sounds/besha.mp3"
];

/* =======================
   STATE
======================= */

let tiles = JSON.parse(localStorage.getItem("tiles")) || Array(GRID_SIZE).fill(BASIC);
let draggedIndex = null;

const grid = document.getElementById("grid");
const instructions = document.getElementById("instructions");
const modal = document.getElementById("modal");
const modalText = document.getElementById("modal-text");
const confettiContainer = document.getElementById("confetti");

/* =======================
   UTILITIES
======================= */

function save() {
  localStorage.setItem("tiles", JSON.stringify(tiles));
}

function playSound() {
  const audio = new Audio(SOUNDS[Math.floor(Math.random()*SOUNDS.length)]);
  audio.volume = 0.6;
  audio.play();
}

function nextEmoji(e) {
  const i = HIERARCHY.indexOf(e);
  return i >= 0 && i < HIERARCHY.length - 1 ? HIERARCHY[i + 1] : null;
}

/* =======================
   EMAIL SEND
======================= */

function sendEmail(answer) {
  emailjs.send("service_pz4rouf","template_jdg5l89",{
    decision: answer,
    date: new Date().toLocaleString()
  });
}

/* =======================
   CONFETTI
======================= */

function launchConfetti() {
  for (let i = 0; i < 120; i++) {
    const c = document.createElement("div");
    c.className = "confetti";
    c.style.left = Math.random() * 100 + "vw";
    c.style.backgroundColor = ["#ff8fab","#ffd6e0","#ffc9de","#ffb3c6","#fb6f92"][Math.floor(Math.random()*5)];
    c.style.animationDuration = (2 + Math.random() * 2) + "s";
    c.style.transform = `rotate(${Math.random()*360}deg)`;
    confettiContainer.appendChild(c);
    setTimeout(() => c.remove(), 4000);
  }
}

/* =======================
   RENDER GRID
======================= */

function render() {
  grid.innerHTML = "";
  tiles.forEach((emoji,index)=>{
    const tile=document.createElement("div");
    tile.className="tile";
    tile.textContent=emoji;
    tile.dataset.index=index;
    tile.draggable=true;

    tile.addEventListener("dragstart",()=>{draggedIndex=index;tile.classList.add("dragging");});
    tile.addEventListener("dragend",()=>{draggedIndex=null;tile.classList.remove("dragging");});
    tile.addEventListener("dragover",e=>e.preventDefault());
    tile.addEventListener("drop",()=>handleDrop(index));

    tile.addEventListener("touchstart",()=>{draggedIndex=index;tile.classList.add("dragging");});
    tile.addEventListener("touchend",e=>{
      tile.classList.remove("dragging");
      const t=document.elementFromPoint(e.changedTouches[0].clientX,e.changedTouches[0].clientY)?.closest(".tile");
      if(t) handleDrop(Number(t.dataset.index));
      draggedIndex=null;
    });

    grid.appendChild(tile);
  });
}

/* =======================
   INSTRUCTIONS
======================= */

function renderInstructions() {
  instructions.innerHTML=`
    <h2>üìñ C√≥mo se juega</h2>
    <ul>
      <li>Arrastra (o desliza) un emoji sobre otro igual.</li>
      <li>Al mezclarlos, evolucionan.</li>
      <li>El original vuelve a ${BASIC}.</li>
    </ul>
    <h2>üèÅ Fin del juego</h2>
    <p>El juego termina cuando creas: <strong>${HIERARCHY.at(-1)}</strong>.</p>
    <h2>üîó Jerarqu√≠a</h2>
    <div class="hierarchy">${HIERARCHY.map(e=>`<span>${e}</span>`).join("‚Üí")}</div>
  `;
}

/* =======================
   MODAL
======================= */

function showModal(text) {
  modalText.textContent=text;
  modal.classList.add("show");
}

document.querySelectorAll(".btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    sendEmail(btn.dataset.answer);
    launchConfetti();
    modal.classList.remove("show");
  });
});

/* =======================
   GAME LOGIC
======================= */

function handleDrop(targetIndex) {
  if(draggedIndex===null||draggedIndex===targetIndex) return;
  if(tiles[draggedIndex]===tiles[targetIndex]) {
    const up=nextEmoji(tiles[targetIndex]);
    if(up){
      tiles[targetIndex]=up;
      tiles[draggedIndex]=BASIC;
      playSound(); save();
      if(up==="üìú") setTimeout(()=>showModal("¬øQuieres ser mi valentine el 14 de febrero? üíñ"),200);
    }
  }
  render();
}

/* =======================
   START
======================= */

render();
renderInstructions();
</script>

</body>
</html>
